# babel-plugin-istanbul-shopee

[前端覆盖率插桩库](http://npm.shopee.io/-/web/detail/babel-plugin-istanbul-shopee) by Seller EPD

A Babel plugin that instruments your code with Istanbul coverage (through [nyc](https://github.com/bcoe/nyc)).

前端覆盖率工具使用文档： https://confluence.shopee.io/pages/viewpage.action?pageId=527797141

## 安装

#### 已接入 seller-center-cli 的无需安装，可直接看下一步配置

### 方式一

#### 为了保持插桩库`babel-plugin-istanbul-shopee`版本最新，推荐部署时单独对插桩库进行安装，需要在部署配置文件(一般在`deploy/`文件夹下)中增加对应安装命令.

```json
// deploy.json部署配置文件示例
···
"build": {
  "commands": [
    "yarn build --env.country=${cid} --env.server=${env}"
  ],
  "upload_static": {
    "static_dir": "dist",
    "enable_cdn": true,
    "cdn_envs": ["test", "uat", "staging", "live", "stable", "liveish"]
  },
  "docker_image": {
    "base_image": "harbor.shopeemobile.com/shopee/nodejs-base",
    "dependent_libraries_files": [
      ".npmrc",
      "package.json",
      "yarn.lock"
    ],
    "run_commands": [
      "yarn install",
      "yarn add babel-plugin-istanbul-shopee --registry https://npm.shopee.io/", // 增加安装插桩库的命令
      "pip install -U shopee-deploy-common"
    ]
  }
}
···
```

### 方式二

增加到`package.json`文件中一并安装，但是需要注意在版本号前加上`^`号，并且不要将版本锁定到`package-lock.json` 或 `yarn.lock`文件中

```
"babel-plugin-istanbul-shopee": "^6.1.xxx"
```

修改 `.npmrc`

```
registry=https://npm.shopee.io/
```

安装命令

```
npm install babel-plugin-istanbul-shopee

yarn add babel-plugin-istanbul-shopee

```

## 配置

主要需要进行两步配置（都只针对非正式环境）：

1. 在 babel 配置文件中增加对 `babel-plugin-istanbul-shopee` 插桩库的引用，用于代码插桩。
2. 在 webpack 配置文件中增加对`babel-plugin-istanbul-shopee`库`plugin/uploadCoveragePlugin.js`的引用，用于上传插桩位置及 git 相关数据。

### 方式一：

seller-center-cli 已支持在 local.config.js 中通过`enableTestCoverage`和`testCoverageConfig`字段配置测试覆盖率插件，详细配置如下：

```js
return {
  // ......
  enableTestCoverage: true, // 只会在test环境生效
  testCoverageConfig: {
    gitProjectId: xxx, // 必填
    gitProject: xxx, // 默认值：localConfig.getProjectName()，如果localConfig中的projectName和git project name不一致，需要单独配置
    commitId: xxx, // 默认值：localConfig.deploymentBuild.commit
    branch: xxx, // 默认值：localConfig.deploymentBuild.branch
    extension: [], // 默认值：['.js', '.vue', '.ts', '.tsx']
    coverageFile: xxx, // 默认值：__coverage__.txt
    istanbul: true,
    cwd: process.cwd(),
    exclude: [], // 默认值：['**/types.ts', '**/typings/**', '**/styles.ts']
  },
  // ......
};
```

如果不使用上述字段，也可自行对前端工程根目录的 `local.config.js` 文件进行修改， 在`babelPlugin`和 `plugins` 字段对应 `test` 环境的配置中，其中`babelPlugin`字段对应`babel`插件，`plugins`字段对应`webpack`插件，配置示例如下：

```js
// babel plugins
var babelPlugin = config.mode === "production" ? ["已有配置"] : ["已有配置"];
// webpack plugins
var plugins = config.mode === "production" ? ["已有配置"] : ["已有配置"];
if (process.env.env == "test") { //设置只针对test环境插桩
  istanbulPath = path.resolve(
    process.cwd(),
    "./node_modules/babel-plugin-istanbul-shopee"
  );
  babelPlugin.push([
    istanbulPath,
    {
      gitProjectId: 0000, //必填，需修改成 git仓库id
      gitProject: "xxx", //必填，需修改成 git仓库名称
      commitId: config.deploymentBuild.commit, //必填
      branch: config.deploymentBuild.branch, //必填
      extension: [".js", ".vue", ".ts", ".tsx"],
      coverageFile: "__coverage__.txt",
      istanbul: true,
      cwd: process.cwd(),
    },
  ]);
  var webpackPath = path.resolve(
    istanbulPath,
    "./plugins/uploadCoveragePlugin.js"
  );
  if (fs.existsSync(webpackPath)) {
    // 上传覆盖率相关数据
    const uploadCoveragePlugin = require(webpackPath);
    plugins.push(
      new uploadCoveragePlugin({
        //覆盖率文件路径配置需与babel配置中的cwd+coverageFile保持一致
        coveragePath: path.resolve(process.cwd(), "__coverage__.txt")
      })
    );
  }
}

return {
 ···
  // babel plugins
  babelPlugin: babelPlugin,
  // webpack plugins
  plugins: plugins,
 ···
}
```

参数详情

| 参数名称       | 描述                                                                                              | 是否必填 | 类型            | 默认值                                                                                    |
| -------------- | ------------------------------------------------------------------------------------------------- | -------- | --------------- | ----------------------------------------------------------------------------------------- |
| `gitProjectId` | git 仓库 id                                                                                       | `true`   | `int`           |                                                                                           |
| `gitProject`   | git 仓库名称                                                                                      | `true`   | `String`        |                                                                                           |
| `commitId`     | git commitId，在`local.config.js` 文件中配置时必填                                                | `false`  | `String>`       |                                                                                           |
| `branch`       | git 分支名，在`local.config.js` 文件中配置时必填                                                  | `false`  | `String`        |                                                                                           |
| `extension`    | 需要插桩的文件名后缀，注意 vue 工程需要单独加上`.vue`，即：`['.js', '.vue', '.ts', '.tsx']`       | `false`  | `Array<String>` | `['.js', '.cjs', '.mjs', '.ts', '.tsx', '.jsx']`                                          |
| `coverageFile` | 该文件用于收集插桩时的覆盖率数据，默认为`__coverage__.txt`                                        | `false`  | `String`        | `__coverage__.txt`                                                                        |
| `istanbul`     | 是否打开插桩进行覆盖率统计，本地开发环境请设置为 false，代码不进行插桩                            | `false`  | `Boolean`       | `true`                                                                                    |
| `cwd`          | 插桩执行路径，通常为打包命令执行路径                                                              | `false`  | `String`        | 工程根目录                                                                                |
| `exclude`      | 插桩时需要忽略统计的文件/文件夹，支持匹配                                                         | `false`  | `Array<String>` | [插桩库默认排除目录](https://github.com/istanbuljs/schema/blob/master/default-exclude.js) |
| `include`      | 插桩时需要统计的文件/文件夹，支持匹配                                                             | `false`  | `Array<String>` | `src`                                                                                     |
| `extraPath`    | 额外的插桩路径，用于单个 git 仓库包含多个打包路径时传入额外的相对路径，保证覆盖率报告的正常生成 | `false`  | `String`        |                                                                                           |

更多可配置参数参考[`nyc -- common-configuration-options`](https://github.com/istanbuljs/nyc#common-configuration-options)

### 方式二：

针对 babel 和 webpack 分别通过指定格式的文件进行配置的前端工程：

1.修改 `.babelrc` 或 `babel.config.js` `test` 环境的配置:

```js
//eg: .babelrc
{
  "env": {
    "test": {  //仅在process.env.NODE_ENV == 'test'时，引入插桩库
      "plugins": [
        [
          "istanbul-shopee", //默认会拼上babel-plugin的前缀
          {
            gitProjectId: 0000, //必填，需修改成 git仓库id
            gitProject: "xxx", //必填，需修改成 git仓库名称
            extension: [".js", ".vue", ".ts", ".tsx"],
            coverageFile: "__coverage__.txt",
            cwd: "", //需修改成插桩执行根目录，默认为工程根目录
            istanbul: true,
          }
        ]
      ]
    }
  }
}

//eg: babel.config.js
const plugins = ["已有配置"];
if (process.env.NODE_ENV == 'test') { //也可使用Jenkins的环境变量进行判断：process.env.ENV == 'test'
  plugins.push([
    "babel-plugin-istanbul-shopee", {
        gitProjectId: 0000, //必填，需修改成 git仓库id
        gitProject: "xxx", //必填，需修改成 git仓库名称
        extension: [".js", ".vue", ".ts", ".tsx"],
        coverageFile: "__coverage__.txt",
        istanbul: true,
        cwd: process.cwd(),
    },
  ])
}
module.exports = {
  presets: ["xxx"],
  plugins
}
```

2.修改`webpack.config.js` `test` 环境的配置，在`plugins`字段中增加:

```js
const uploadCoveragePlugin = require('babel-plugin-istanbul-shopee/plugins/uploadCoveragePlugin');
new uploadCoveragePlugin({
  //覆盖率文件路径配置需与babel配置中的cwd+coverageFile保持一致
  coveragePath: path.resolve(process.cwd(), '__coverage__.txt')
}),
```

## 问题汇总

1、前端工程配置`babel-plugin-istanbul-shopee`后，通过`const { xxx } = XXX`等方式`import`的依赖库出现`xxx is not defined`的问题

解决办法：

在 babel 的 plugin 配置中，插桩库前面增加`@babel/plugin-transform-modules-commonjs`插件即可

2、babel 通过`.babelrc`文件配置，且`process.env.NODE_ENV`设置为`mode`的情况，因`mode`的值为`development`, `production` 或 `none`中的一个 ,导致`NODE_ENV`的值不会等于`test`，插桩库引入失败的问题

解决办法：

1. 改为通过`babel.config.js`作为 babel 配置文件
2. 修改引入插桩库的代码逻辑，如：
   通过 Jenkins 部署时，可以使用`ENV`的环境变量进行判断，将`process.env.ENV == 'test'`作为是否引入插桩库的判断

3、前端文件因注释行格式问题导致插桩位置映射关系错误

解决办法：

统一规范前端工程注释行格式：

单行注释

```js
// xxx
或;
/* xxx */
```

多行注释

```js
/**
 * 使用注释块
 * /
```

错误示例

```js
/** 单行注释使用注释块，将导致注释行识别失败 * /
```
